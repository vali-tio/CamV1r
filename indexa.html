<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Age Filter Camera (No Broken Image)</title>
  <style>
    body{margin:0;font-family:sans-serif;background:#0b1020;color:#e7ecff;display:flex;flex-direction:column;align-items:center;padding:10px}
    h2{margin:12px 0}
    .preview{position:relative;width:90%;max-width:400px;aspect-ratio:3/4;background:#000;border-radius:12px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.4)}
    video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .controls{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    button,input[type=range]{cursor:pointer}
    button{background:#2f7cfb;color:#fff;border:none;padding:10px 14px;border-radius:8px;font-weight:600;box-shadow:0 6px 14px rgba(46,116,255,.3)}
    button.secondary{background:transparent;color:#e7ecff;border:1px solid rgba(255,255,255,.3);box-shadow:none}
    label{font-size:14px;color:#93a0c4}
  </style>
</head>
<body>
  <h2>Age Filter Camera</h2>
  <div class="preview">
    <video id="video" playsinline muted></video>
    <canvas id="canvas"></canvas>
  </div>

  <div class="controls">
    <button id="btnShot">üì∏ Capture</button>
    <button id="btnSwitch" class="secondary">üîÑ Switch Camera</button>
    <button id="btnDownload" class="secondary">‚¨áÔ∏è Download</button>
  </div>

  <div class="controls">
    <button id="modeYoung" class="secondary">Young</button>
    <button id="modeOld">Old</button>
  </div>

  <div class="controls">
    <label>Intensity <input id="intensity" type="range" min="0" max="100" value="65"></label>
    <label>Vignette <input id="vignette" type="range" min="0" max="100" value="35"></label>
    <label>Wrinkles <input id="wrinkles" type="range" min="0" max="100" value="70"></label>
  </div>

<script>
const video=document.getElementById('video');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
let facingMode='user';
let mode='old';

const modeYoungBtn=document.getElementById('modeYoung');
const modeOldBtn=document.getElementById('modeOld');
const intensityEl=document.getElementById('intensity');
const vignetteEl=document.getElementById('vignette');
const wrinklesEl=document.getElementById('wrinkles');
const btnShot=document.getElementById('btnShot');
const btnSwitch=document.getElementById('btnSwitch');
const btnDownload=document.getElementById('btnDownload');

async function startCamera(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode},audio:false});
    video.srcObject=stream;await video.play();
    resize();requestAnimationFrame(loop);
  }catch(e){alert('Camera error: '+e.message);}
}
function resize(){
  const r=video.videoWidth/video.videoHeight||3/4;
  const w=video.parentElement.clientWidth;const h=w/r;
  canvas.width=w;canvas.height=h;
}
window.addEventListener('resize',resize);

function applyYoung(){
  ctx.filter='none';
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  ctx.globalAlpha=intensityEl.value/100*0.6;ctx.filter='blur(1.3px)';ctx.globalCompositeOperation='screen';ctx.drawImage(canvas,0,0);
  ctx.globalAlpha=1;ctx.globalCompositeOperation='source-over';
  ctx.filter='saturate(1.12) contrast(1.04) brightness(1.06)';ctx.drawImage(canvas,0,0);
  drawVignette(vignetteEl.value/100*0.35);
  ctx.filter='none';ctx.globalCompositeOperation='source-over';
}

function applyOld(){
  ctx.filter=`saturate(${lerp(1,0.68,intensity())}) contrast(${lerp(1,1.22,intensity())}) brightness(${lerp(1,0.95,intensity())})`;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  
  // Wrinkle pattern (generated, no image)
  const density=Math.floor(wrinklesEl.value/10);
  ctx.globalAlpha=0.15*intensity();
  ctx.globalCompositeOperation='multiply';
  ctx.strokeStyle='rgba(80,80,80,0.6)';
  ctx.lineWidth=0.5;
  for(let i=0;i<density;i++){
    ctx.beginPath();
    let y=Math.random()*canvas.height;
    ctx.moveTo(0,y);
    for(let x=0;x<canvas.width;x+=20){
      ctx.lineTo(x,y+Math.sin(x/15+Math.random()*3)*2);
    }
    ctx.stroke();
  }

  // Grain
  grain(intensity()*0.28);

  // Vignette
  drawVignette(vignetteEl.value/100*0.6);

  ctx.globalAlpha=1;ctx.globalCompositeOperation='source-over';ctx.filter='none';
}

function grain(a){
  const w=canvas.width,h=canvas.height;
  const img=ctx.getImageData(0,0,w,h);
  const d=img.data;
  for(let i=0;i<d.length;i+=4){
    const n=(Math.random()*2-1)*64;
    d[i]=clampByte(d[i]+n*a);d[i+1]=clampByte(d[i+1]+n*a);d[i+2]=clampByte(d[i+2]+n*a);
  }
  ctx.putImageData(img,0,0);
}
function drawVignette(s){
  const w=canvas.width,h=canvas.height;
  const g=ctx.createRadialGradient(w/2,h/2,Math.min(w,h)*0.3,w/2,h/2,Math.max(w,h)*0.75);
  g.addColorStop(0,'rgba(0,0,0,0)');
  g.addColorStop(1,`rgba(0,0,0,${s})`);
  ctx.globalCompositeOperation='multiply';
  ctx.fillStyle=g;ctx.fillRect(0,0,w,h);
  ctx.globalCompositeOperation='source-over';
}
function loop(){resize();if(mode==='young')applyYoung();else applyOld();requestAnimationFrame(loop);}
function intensity(){return intensityEl.value/100}
function lerp(a,b,t){return a+(b-a)*t}
function clampByte(v){return Math.max(0,Math.min(255,v|0))}

btnShot.onclick=()=>{const url=canvas.toDataURL('image/png');const w=window.open();w.document.write(`<img src=\"${url}\" style=\"width:100%\"/>`);}
btnDownload.onclick=()=>{const a=document.createElement('a');a.download=`age-filter-${mode}.png`;a.href=canvas.toDataURL('image/png');a.click();}
btnSwitch.onclick=async()=>{const s=video.srcObject;if(s){s.getTracks().forEach(t=>t.stop())}facingMode=(facingMode==='user')?'environment':'user';await startCamera();}
modeYoungBtn.onclick=()=>{mode='young';modeOldBtn.classList.add('secondary');modeYoungBtn.classList.remove('secondary')}
modeOldBtn.onclick=()=>{mode='old';modeYoungBtn.classList.add('secondary');modeOldBtn.classList.remove('secondary')}

startCamera();
</script>
</body>
</html>

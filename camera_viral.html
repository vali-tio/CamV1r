<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Mobile Filter Wadah</title>
  <meta name="description" content="Wadah filter mobile: portrait + environment filters, sparkle, flip camera, light/dark UI." />
  <style>
    :root{
      --bg-light:#f5f7fb;
      --bg-dark:#071018;
      --control-bg: rgba(255,255,255,0.92);
      --control-bg-dark: rgba(20,20,20,0.7);
      --accent: #ff6b6b;
      --btn-size: 64px;
      --small-btn: 44px;
    }
    html,body{
      height:100%;
      margin:0;
      -webkit-tap-highlight-color: transparent;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg-light);
      color:#111;
      overscroll-behavior: none;
      touch-action: manipulation;
    }
    body.dark{
      background: var(--bg-dark);
      color: #f2f7fb;
    }

    /* Container full screen fixed so page doesn't scroll */
    #root{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }

    /* video & overlay */
    #video, #overlayCanvas {
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      transform-origin:center;
      -webkit-transform-origin:center;
    }

    /* top bar */
    .topbar{
      position:absolute;
      top:12px;
      left:12px;
      right:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      pointer-events:auto;
    }
    .segmented {
      display:flex;
      gap:8px;
      background:transparent;
    }
    .segmented button {
      padding:6px 10px;
      border-radius:999px;
      border:none;
      font-size:13px;
      background: rgba(0,0,0,0.35);
      color:white;
      backdrop-filter: blur(4px);
    }
    .label {
      margin:auto;
      position:absolute;
      top:14px;
      left:50%;
      transform:translateX(-50%);
      background: rgba(0,0,0,0.45);
      color:white;
      padding:6px 12px;
      border-radius:999px;
      font-size:13px;
      pointer-events:none;
    }

    /* controls bottom */
    .bottombar{
      position:absolute;
      bottom:14px;
      left:12px;
      right:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:14px;
      pointer-events:auto;
    }

    .btn {
      width:var(--small-btn);
      height:var(--small-btn);
      border-radius:999px;
      border:none;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      background: var(--control-bg);
      box-shadow: 0 6px 18px rgba(0,0,0,0.18);
    }
    body.dark .btn { background:var(--control-bg-dark); color:#fff; }

    .capture {
      width: var(--btn-size);
      height: var(--btn-size);
      border-radius:50%;
      background: var(--control-bg);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:26px;
    }
    body.dark .capture { background:var(--control-bg-dark); color:#fff; }

    /* small utility panel (left) */
    .leftpanel{
      position:absolute;
      left:12px;
      bottom:90px;
      display:flex;
      flex-direction:column;
      gap:10px;
      pointer-events:auto;
    }
    .rightpanel{
      position:absolute;
      right:12px;
      bottom:90px;
      display:flex;
      flex-direction:column;
      gap:10px;
      pointer-events:auto;
    }

    /* filter strip */
    .filterStrip{
      position:absolute;
      left:12px;
      right:12px;
      bottom:160px;
      display:flex;
      gap:8px;
      overflow:auto;
      padding:6px;
      pointer-events:auto;
    }
    .filterChip{
      padding:8px 10px;
      border-radius:999px;
      background:rgba(255,255,255,0.85);
      white-space:nowrap;
      font-size:13px;
      border:none;
    }
    body.dark .filterChip{ background: rgba(20,20,20,0.6); color:#fff; }

    /* hint */
    .hint{
      position:absolute;
      left:12px;
      top:70%;
      transform:translateY(-50%);
      font-size:12px;
      background: rgba(0,0,0,0.35);
      color:#fff;
      padding:6px 8px;
      border-radius:8px;
    }

    /* preview modal */
    .previewModal{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,0.6);
      z-index:40;
    }
    .previewModal.open{ display:flex; }
    .previewCard{
      width:92%;
      max-width:680px;
      border-radius:12px;
      overflow:hidden;
      background:#fff;
      box-shadow:0 10px 40px rgba(0,0,0,0.3);
    }
    body.dark .previewCard{ background:#0b1b26; color:#fff; }

    .previewCard img{ width:100%; display:block; }

    /* small responsiveness */
    @media (min-width:720px){
      :root{ --btn-size:80px; --small-btn:56px; }
    }
  </style>
</head>
<body>
  <div id="root" class="app">
    <video id="video" playsinline autoplay muted></video>
    <canvas id="overlayCanvas"></canvas>

    <div class="topbar">
      <div class="segmented" role="tablist">
        <button id="portraitBtn">Portrait</button>
        <button id="envBtn">Environment</button>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button id="sparkleBtn" class="btn" title="Toggle sparkle">‚ú®</button>
        <button id="flipBtn" class="btn" title="Flip camera">üîÅ</button>
        <button id="uiDarkBtn" class="btn" title="Toggle UI light/dark">üåô</button>
      </div>
    </div>

    <div class="label" id="filterLabel">Loading...</div>

    <div class="filterStrip" id="filterStrip" aria-hidden="false"></div>

    <div class="leftpanel" aria-hidden="true">
      <!-- reserved for future small controls -->
    </div>

    <div class="rightpanel" aria-hidden="true">
      <button id="prevFilter" class="btn" title="Previous filter">‚óÄ</button>
      <button id="nextFilter" class="btn" title="Next filter">‚ñ∂</button>
    </div>

    <div class="bottombar">
      <div style="width:80px;"></div>
      <button id="captureBtn" class="capture" title="Capture">üì∏</button>
      <div style="width:80px;"></div>
    </div>

    <!-- hidden canvas for final capture -->
    <canvas id="photoCanvas" style="display:none;"></canvas>

    <!-- preview modal -->
    <div id="preview" class="previewModal" role="dialog" aria-modal="true">
      <div class="previewCard">
        <img id="previewImg" alt="Preview"/>
        <div style="display:flex;gap:8px;padding:10px;justify-content:center;background:rgba(0,0,0,0.03)">
          <button id="downloadPreview" class="btn">Download</button>
          <button id="closePreview" class="btn">Close</button>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // Elements
  const video = document.getElementById('video');
  const overlay = document.getElementById('overlayCanvas');
  const photoCanvas = document.getElementById('photoCanvas');
  const filterLabel = document.getElementById('filterLabel');
  const captureBtn = document.getElementById('captureBtn');
  const nextFilterBtn = document.getElementById('nextFilter');
  const prevFilterBtn = document.getElementById('prevFilter');
  const portraitBtn = document.getElementById('portraitBtn');
  const envBtn = document.getElementById('envBtn');
  const filterStrip = document.getElementById('filterStrip');
  const sparkleBtn = document.getElementById('sparkleBtn');
  const flipBtn = document.getElementById('flipBtn');
  const uiDarkBtn = document.getElementById('uiDarkBtn');
  const preview = document.getElementById('preview');
  const previewImg = document.getElementById('previewImg');
  const downloadPreview = document.getElementById('downloadPreview');
  const closePreview = document.getElementById('closePreview');

  // filter sets
  const portraitFilters = [
    { name:'Light Glow', css: 'brightness(1.18) saturate(1.25) contrast(1.02)' },
    { name:'Dark Cinematic', css: 'brightness(0.78) contrast(1.35) saturate(1.05) hue-rotate(-8deg)' },
    { name:'Soft Beauty', css: 'brightness(1.08) saturate(1.05) contrast(1.02) blur(0px)' },
    { name:'Retro Vibes', css: 'contrast(0.95) saturate(0.85) sepia(0.12) contrast(1.02)' }
  ];
  const envFilters = [
    { name:'Normal', css:'none' },
    { name:'Warm Sunset', css: 'hue-rotate(-20deg) saturate(1.3) brightness(1.05)' },
    { name:'Cool Night', css: 'hue-rotate(160deg) saturate(1.15) brightness(0.82)' },
    { name:'Cyber Neon', css: 'hue-rotate(240deg) saturate(1.8) contrast(1.15)' },
    { name:'Retro Sepia', css: 'sepia(0.6) contrast(1.05)' }
  ];

  // state
  let filterGroup = 'portrait'; // 'portrait' | 'env'
  let filterIndex = 0;
  let sparkleOn = true;
  let facingMode = 'user'; // 'user' or 'environment'
  let currentStream = null;

  // helpers: start camera
  async function startCamera(){
    try {
      if (currentStream) {
        currentStream.getTracks().forEach(t => t.stop());
        currentStream = null;
      }
      const constraints = { video: { facingMode }, audio: false };
      const s = await navigator.mediaDevices.getUserMedia(constraints);
      currentStream = s;
      video.srcObject = s;
      await video.play();
      resizeOverlay();
      renderSparkles(); // restart overlay loop
      updateUI();
    } catch (err) {
      console.error('Camera error:', err);
      alert('Tidak dapat mengakses kamera. Pastikan izinkan kamera dan buka menggunakan browser yang mendukung (Chrome/Firefox).');
    }
  }

  // apply current filter to video
  function applyFilterToVideo(){
    const f = (filterGroup === 'portrait') ? portraitFilters[filterIndex] : envFilters[filterIndex];
    video.style.filter = f.css;
    filterLabel.innerText = `${f.name} ‚Ä¢ ${filterGroup === 'portrait' ? 'Portrait' : 'Environment'}`;
  }

  // update filter strip (clickable chips)
  function renderFilterStrip(){
    filterStrip.innerHTML = '';
    const arr = (filterGroup === 'portrait') ? portraitFilters : envFilters;
    arr.forEach((it, idx) => {
      const b = document.createElement('button');
      b.className = 'filterChip';
      b.innerText = it.name;
      b.onclick = () => { filterIndex = idx; applyFilterToVideo(); highlightStrip(); };
      filterStrip.appendChild(b);
    });
    highlightStrip();
  }
  function highlightStrip(){
    Array.from(filterStrip.children).forEach((el, i) => {
      el.style.opacity = (i === filterIndex) ? '1' : '0.65';
      el.style.transform = (i === filterIndex) ? 'scale(1.03)' : 'scale(1)';
    });
  }

  // controls
  nextFilterBtn.addEventListener('click', () => {
    const arr = (filterGroup === 'portrait') ? portraitFilters : envFilters;
    filterIndex = (filterIndex + 1) % arr.length;
    applyFilterToVideo(); highlightStrip();
  });
  prevFilterBtn.addEventListener('click', () => {
    const arr = (filterGroup === 'portrait') ? portraitFilters : envFilters;
    filterIndex = (filterIndex - 1 + arr.length) % arr.length;
    applyFilterToVideo(); highlightStrip();
  });

  portraitBtn.addEventListener('click', () => {
    filterGroup = 'portrait'; filterIndex = 0; renderFilterStrip(); applyFilterToVideo();
  });
  envBtn.addEventListener('click', () => {
    filterGroup = 'env'; filterIndex = 0; renderFilterStrip(); applyFilterToVideo();
  });

  sparkleBtn.addEventListener('click', () => {
    sparkleOn = !sparkleOn;
    sparkleBtn.style.opacity = sparkleOn ? '1' : '0.45';
  });

  flipBtn.addEventListener('click', async () => {
    facingMode = (facingMode === 'user') ? 'environment' : 'user';
    await startCamera();
  });

  uiDarkBtn.addEventListener('click', () => {
    document.body.classList.toggle('dark');
  });

  // capture flow: draw video & overlay to hidden canvas, show preview modal
  captureBtn.addEventListener('click', async () => {
    if (!video.videoWidth || !video.videoHeight) {
      alert('Camera belum siap. Tunggu beberapa detik lalu coba lagi.');
      return;
    }
    // set canvas size
    photoCanvas.width = video.videoWidth;
    photoCanvas.height = video.videoHeight;
    const ctx = photoCanvas.getContext('2d');

    // apply currently-used CSS filter to context for parity
    const f = (filterGroup === 'portrait') ? portraitFilters[filterIndex] : envFilters[filterIndex];
    ctx.filter = f.css || 'none';

    // video mirror for user-facing camera
    if (facingMode === 'user') {
      ctx.save();
      ctx.translate(photoCanvas.width, 0);
      ctx.scale(-1,1);
      ctx.drawImage(video, 0, 0, photoCanvas.width, photoCanvas.height);
      ctx.restore();
    } else {
      ctx.drawImage(video, 0, 0, photoCanvas.width, photoCanvas.height);
    }

    // draw overlay canvas (sparkles) if enabled
    if (sparkleOn) {
      try {
        ctx.drawImage(overlay, 0, 0, photoCanvas.width, photoCanvas.height);
      } catch(e){ /* cross-origin or size mismatch ignored */ }
    }

    // show preview
    const dataUrl = photoCanvas.toDataURL('image/png');
    previewImg.src = dataUrl;
    preview.classList.add('open');
  });

  // preview controls
  closePreview.addEventListener('click', () => {
    preview.classList.remove('open');
  });
  downloadPreview.addEventListener('click', () => {
    const url = previewImg.src;
    const a = document.createElement('a');
    a.href = url;
    a.download = `filter-${Date.now()}.png`;
    a.click();
  });

  // resize overlay canvas to match video element
  function resizeOverlay(){
    const w = video.videoWidth || video.clientWidth || window.innerWidth;
    const h = video.videoHeight || video.clientHeight || window.innerHeight;
    overlay.width = w;
    overlay.height = h;
    overlay.style.width = '100%';
    overlay.style.height = '100%';
  }
  window.addEventListener('resize', resizeOverlay);

  // sparkle particle animation
  let sparkleRAF = null;
  function renderSparkles(){
    cancelAnimationFrame(sparkleRAF);
    const ctx = overlay.getContext('2d');
    const particles = Array.from({length: 28}).map(()=>({
      x: Math.random()*overlay.width,
      y: Math.random()*overlay.height,
      r: 1 + Math.random()*3,
      vx: (Math.random()-0.5)*0.6,
      vy: - (0.2 + Math.random()*0.8),
      life: 60 + Math.random()*120,
      maxLife: 60 + Math.random()*120
    }));
    function loop(){
      ctx.clearRect(0,0,overlay.width,overlay.height);
      if (!sparkleOn) { sparkleRAF = requestAnimationFrame(loop); return; }
      particles.forEach(p=>{
        p.x += p.vx;
        p.y += p.vy;
        p.life--;
        if (p.life <= 0) {
          p.x = Math.random()*overlay.width;
          p.y = overlay.height + 10;
          p.r = 1 + Math.random()*3;
          p.vx = (Math.random()-0.5)*0.6;
          p.vy = - (0.2 + Math.random()*0.8);
          p.life = p.maxLife;
        }
        const alpha = Math.max(0, Math.min(1, p.life / p.maxLife));
        ctx.beginPath();
        ctx.fillStyle = `rgba(255,255,255,${alpha*0.9})`;
        ctx.shadowColor = `rgba(255,255,255,${alpha})`;
        ctx.shadowBlur = 8;
        ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
        ctx.fill();
      });
      sparkleRAF = requestAnimationFrame(loop);
    }
    loop();
  }

  // initial setup
  function updateUI(){
    applyFilterToVideo();
    renderFilterStrip();
    sparkleBtn.style.opacity = sparkleOn ? '1' : '0.45';
    portraitBtn.style.background = filterGroup === 'portrait' ? 'rgba(255,255,255,0.9)' : '';
    envBtn.style.background = filterGroup === 'env' ? 'rgba(255,255,255,0.9)' : '';
  }

  // page load
  (async function init(){
    // set a calm timeout to allow browser to settle on mobile
    await startCamera();
    applyFilterToVideo();
    renderFilterStrip();
    renderSparkles();
  })();

  // Prevent double-tap zoom and overscroll on mobile while interacting
  let lastTouch = 0;
  document.addEventListener('touchstart', (e)=> {
    const now = Date.now();
    if (now - lastTouch < 300) e.preventDefault();
    lastTouch = now;
  }, {passive:false});

})();
</script>
</body>
</html>
